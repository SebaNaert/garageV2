{% extends 'base.html.twig' %}

{% block title %}Modifier {{ voiture.marque }} {{ voiture.modele }}{% endblock %}

{% block body %}
<div class="edit-voiture-container block">
    <h1>Modifier {{ voiture.marque }} {{ voiture.modele }}</h1>

    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

        {# Champs principaux de la voiture #}
        {{ form_row(form.marque) }}
        {{ form_row(form.modele) }}
        {{ form_row(form.kilometrage) }}
        {{ form_row(form.prix) }}
        {{ form_row(form.nombreProprietaires) }}
        {{ form_row(form.cylindree) }}
        {{ form_row(form.puissance) }}
        {{ form_row(form.carburant) }}
        {{ form_row(form.anneeMiseEnCirculation) }}
        {{ form_row(form.transmission) }}
        {{ form_row(form.description) }}
        {{ form_row(form.options) }}
        {{ form_row(form.imageCouverture) }}

        {# Galerie d'images existantes #}
        <h3>Galerie d'images</h3>
        <div id="voiture_voitureImages" data-prototype="{{ form_widget(form.voitureImages.vars.prototype)|e('html_attr') }}">
            {% for imageForm in form.voitureImages %}
                <div class="form-group border p-2 mb-2">
                    {{ form_row(imageForm.imageName) }}
                    {{ form_row(imageForm.caption) }}
                    {% if imageForm.vars.data.imageName %}
                        <img src="{{ asset('uploads/voitures/' ~ imageForm.vars.data.imageName) }}" alt="Image {{ loop.index }}" class="img-thumbnail mt-2" />
                    {% endif %}
                    <button type="button" class="btn btn-danger remove-image mt-20">Supprimer</button>
                </div>
            {% endfor %}
        </div>

        <input type="hidden" id="widgets-counter" value="{{ form.voitureImages|length }}">
        <button type="button" id="add-image" class="btn btn-secondary mb-3">Ajouter une image</button>

        {# Boutons d'action #}
        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-primary">Enregistrer les modifications</button>
            <a href="{{ path('voiture_show', {'id': voiture.id}) }}" class="btn btn-primary btn-small">Retour</a>
        </div>

    {{ form_end(form) }}

    {# Supprimer la voiture entière #}
    <form method="post" action="{{ path('admin_voiture_delete', {'id': voiture.id}) }}" onsubmit="return confirm('Voulez-vous vraiment supprimer cette voiture ?');" class="mt-3">
        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ voiture.id) }}">
        <button type="submit" class="btn btn-danger mt-20">Supprimer l'annonce</button>
    </form>
</div>

{# JS pour ajouter/supprimer dynamiquement des images #}
<script>
const addImageBtn = document.querySelector('#add-image');
const container = document.querySelector('#voiture_voitureImages');
let index = parseInt(document.querySelector('#widgets-counter').value);

// Ajouter un nouveau champ image
addImageBtn.addEventListener('click', () => {
    const prototype = container.dataset.prototype.replace(/__name__/g, index);

    const div = document.createElement('div');
    div.classList.add('form-group', 'border', 'p-2', 'mb-2');
    div.innerHTML = prototype + '<button type="button" class="btn btn-danger remove-image mt-2">Supprimer</button>';
    container.appendChild(div);

    // Ajouter l'événement pour supprimer ce champ
    div.querySelector('.remove-image').addEventListener('click', () => {
        div.remove();
    });

    index++;
});

// Supprimer les champs existants
document.querySelectorAll('.remove-image').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.form-group').remove();
    });
});
</script>
{% endblock %}
