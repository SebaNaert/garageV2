{% extends 'base.html.twig' %}

{% block title %}Ajouter une voiture{% endblock %}

{% block body %}
<h1>Ajouter une voiture</h1>

{# Démarrage du formulaire, encodage pour upload de fichiers #}
{{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

{# Affichage des erreurs globales du formulaire #}
{% if form.vars.errors|length > 0 %}
    <div class="alert alert-danger">
        <ul>
        {% for error in form.vars.errors %}
            <li>{{ error.message }}</li>
        {% endfor %}
        </ul>
    </div>
{% endif %}

{# Champs principaux avec erreurs individuelles #}
<div class="mb-3">
    {{ form_row(form.marque) }}
    {{ form_row(form.modele) }}
    {{ form_row(form.kilometrage) }}
    {{ form_row(form.prix) }}
    {{ form_row(form.nombreProprietaires) }}
    {{ form_row(form.cylindree) }}
    {{ form_row(form.puissance) }}
    {{ form_row(form.carburant) }}
    {{ form_row(form.anneeMiseEnCirculation) }}
    {{ form_row(form.transmission) }}
    {{ form_row(form.description) }}
    {{ form_row(form.options) }}
    {{ form_row(form.imageCouverture) }}
</div>

{# Galerie d'images #}
<h3>Galerie d'images</h3>
<div id="voiture_voitureImages" data-prototype="{{ form_widget(form.voitureImages.vars.prototype)|e('html_attr') }}">
    {% for imageForm in form.voitureImages %}
        <div class="form-group border p-2 mb-2">
            {{ form_row(imageForm.imageName) }}
            {{ form_row(imageForm.caption) }}
            <button type="button" class="btn btn-danger remove-image">Supprimer</button>
        </div>
    {% endfor %}
</div>
<input type="hidden" id="widgets-counter" value="{{ form.voitureImages|length }}">

<button type="button" id="add-image" class="btn btn-secondary mb-3">Ajouter une image</button>

<div class="mt-3">
    <button class="btn btn-primary">Ajouter la voiture</button>
</div>

{{ form_end(form) }}

{# JS pour ajouter/supprimer dynamiquement les champs de la galerie #}
<script>
const addImageBtn = document.querySelector('#add-image');
const container = document.querySelector('#voiture_voitureImages');
let index = parseInt(document.querySelector('#widgets-counter').value);

// Ajouter un nouveau champ image
addImageBtn.addEventListener('click', () => {
    const prototype = container.dataset.prototype;
    const newForm = prototype.replace(/__name__/g, index);

    const div = document.createElement('div');
    div.classList.add('form-group', 'border', 'p-2', 'mb-2');
    div.innerHTML = newForm + '<button type="button" class="btn btn-danger remove-image mt-2">Supprimer</button>';
    container.appendChild(div);

    // Ajouter l'événement pour supprimer ce champ
    div.querySelector('.remove-image').addEventListener('click', () => {
        div.remove();
    });

    index++;
});

// Supprimer les champs existants
document.querySelectorAll('.remove-image').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.form-group').remove();
    });
});
</script>
{% endblock %}
